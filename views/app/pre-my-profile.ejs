<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="theme-color" content="#1e2750" />

    <meta
      name="description"
      content="Join Vibrer's prelaunch and be the first to experience a revolutionary music platform. Connect, discover, and engage with artists and music enthusiasts worldwide."
    />
    <meta
      name="keywords"
      content="music platform, music community, music discovery, artist connection, music enthusiasts"
    />
    <%- include('../partials/head'); %>
    <link
      rel="stylesheet"
      href="/public/plugins/file-uploader/dist/font/font-fileuploader.css"
    />
    <link
      rel="stylesheet"
      href="/public/plugins/file-uploader/dist/jquery.fileuploader.min.css"
    />
    <link
      rel="stylesheet"
      href="/public/plugins/file-uploader/modules/avatar/css/jquery.fileuploader-theme-avatar.css"
    />
    <link rel="stylesheet" href="/public/style/app.css?v=3.1" />
    <link rel="stylesheet" href="/public/style/app_ext.css?v=3.1" />
    <link rel="stylesheet" href="/public/style/modal.css?v=3.1" />
    <link href="/public/style/video-js.css?v=3.1" rel="stylesheet" />
    <link rel="stylesheet" href="/public/style/contests.css?v=3.1" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"
      integrity="sha512-k2WPPrSgRFI6cTaHHhJdc8kAXaRM4JBFEDo1pPGGlYiOyv4vnA0Pp0G5XMYYxgAPmtmv/IIaQA6n5fLAyJaFMA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script src="/public/js/config.js?v=3.1"></script>
    <script>
      var i18n = {
        lang: '<%= __("lang") %>',
        edit: '<%= __("edit") %>',
        upload: '<%= __("upload") %>',
        delete: '<%= __("delete") %>',
      };
    </script>
    <script src="/public/plugins/file-uploader/dist/jquery.fileuploader.min.js?v=3.1"></script>
    <script src="/public/plugins/file-uploader/modules/avatar/js/custom.js?v=3.1"></script>
    <link rel="stylesheet" href="/public/style/customFile.css" />
    <!-- Croppie CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css"
    />

    <!-- Croppie JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js?v=3.1"></script>
    <style>
      #profile_cover,
      #profile_avatar,
      #add_gallery,
      .hidden {
        display: none;
        visibility: hidden;
        width: 0;
        height: 0;
      }
      .toast.error {
        color: rgb(179, 15, 15);
        border-color: rgb(179, 15, 15);
      }

      .fileuploader-wrapper {
        border: solid 2px #fff;
      }
    </style>
  </head>
  <body class="body-dark _pr">
    <!-- loader -->
    <%- include('../partials/loader'); %>

    <!-- header -->
    <%- include('./partials/pre-header'); %>
    <div class="crop-overlay"></div>
    <div
      class="hidden-coverWrap d-none"
      style="top: 40px; transform: translate(-50%, 0%)"
    >
      <input style="display: none" type="file" id="upload" accept="image/*" />
      <div id="croppie-container"></div>
      <div class="d-flex">
        <button class="btn btn-sm btn-primary" id="uploadCover">
          Upload cover
        </button>
        <button class="btn btn-sm cancel-cover">Cancel</button>
      </div>
    </div>
    <main class="app_layout app_wrapper">
      <!-- main body of the app -->
      <div class="app_main preMain">
        <div class="profile_main">
          <div class="profile_header">
            <div class="_action">
              <div class="title"><%- __("my_profile")%></div>
              <div class="_options">
                <div class="head" id="myProfile_options">
                  <img
                    src="/public/images/icons/more-vertical.svg"
                    alt="Icon"
                  />
                </div>
                <div class="drop_down">
                  <div class="_link" id="changeCover">
                    <img src="/public/images/icons/camera.svg" alt="Camera" />
                    <div><%- __("change_cover")%></div>
                  </div>
                  <div class="_link" onclick="toEditProfile()">
                    <img src="/public/images/icons/edit.svg" alt="Edit" />
                    <div><%- __("edit_profile")%></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="cover" id="coverHolder">
              <% if (!profileData.profile_cover || profileData.profile_cover ===
              '') { %>
              <img src="/uploads/cover_img1.jpeg" alt="Cover" id="my_cover" />
              <% } else { %>
              <img
                src="<%= profileData.profile_cover %>"
                alt="Cover"
                id="my_cover"
              />
              <% } %>
            </div>
          </div>

          <div class="profile_wrapper">
            <div class="_profile_left">
              <div id="avatarWrap">
                <input
                  type="file"
                  accept="image/*"
                  id="profile_img"
                  name="profile_img"
                  data-fileuploader-default="<%- profileData.profile_img && profileData.profile_img !== '' ? profileData.profile_img : '/public/plugins/file-uploader/modules/avatar/images/default-avatar.png' %>"
                  class="profileImage"
                />
              </div>
              <!-- </div> -->
              <div class="profile_top_details">
                <div class="name main_name">
                  <span><%- profileData.full_name %></span>
                  <% if(profileData.verified === true){ %>
                  <img
                    class="app_v_badge"
                    src="/public/images/icons/verified-badge.svg"
                    alt="Verified"
                  />
                  <% } %>
                </div>

                <div class="info">
                  <% profileData.artist_categories.forEach(category => { %>
                  <span><%= __("artist_categories." + category.name) %>,</span>
                  <% }); %>
                </div>
              </div>
            </div>

            <div class="profile_action">
              <button class="btn btn-primary btn-sm" onclick="toEditProfile()">
                <%- __("edit_profile")%>
              </button>
            </div>
          </div>

          <div class="profile_content_tabs" style="margin-top: 1rem">
            <div class="_tab_content active" id="userInfo">
              <div class="profile_top_details">
                <div class="name">
                  <span><%- profileData.full_name %></span>
                  <% if(profileData.verified === true){ %>
                  <img
                    class="app_v_badge"
                    src="/public/images/icons/verified-badge.svg"
                    alt="Verified"
                  />
                  <% } %>
                </div>
                <div class="info mt-1">
                  <div class="g_age">
                    <img
                      src="/public/images/icons/gender-<%= profileData.gender.toLowerCase() %>.svg"
                      alt="Gender"
                      title="%= profileData.gender %>"
                    />
                    <% function calculateAge(dateOfBirth) { const birthDate =
                    new Date(dateOfBirth); const currentDate = new Date(); let
                    age = currentDate.getFullYear() - birthDate.getFullYear();
                    if ( currentDate.getMonth() < birthDate.getMonth() ||
                    (currentDate.getMonth() === birthDate.getMonth() &&
                    currentDate.getDate() < birthDate.getDate()) ) { age--; }
                    return age; } %>
                    <div><%= calculateAge(profileData.date_of_birth) %>,</div>
                  </div>
                  <span
                    ><%= profileData.city %>, <% var countryKey =
                    profileData.country.toLowerCase(); %> <%- __(''+countryKey)
                    %></span
                  >
                </div>
              </div>

              <div class="title mt-3"><%- __("username")%>:</div>
              <div class="data"><%= profileData.username %></div>
              <% if(profileData.user_type === 'Artist'){ %>

              <div class="title mt-3"><%- __("genre")%>:</div>
              <div class="data">
                <%= profileData.genres.map(genre => __("genres." +
                genre.name)).join(', ') %>
              </div>
              <% }%> <% if(profileData.link && profileData.link.length > 0) { %>
              <div class="title mt-3"><%- __("other_links")%>:</div>
              <div class="p_social_links mt-2">
                <% for (let platform in profileData.link) { %> <% if
                (profileData.link[platform] !== "") { %>
                <div class="link">
                  <div class="title">
                    <%= platform.charAt(0).toUpperCase() + platform.slice(1) %>
                  </div>
                  <a href="<%= profileData.link[platform] %>" target="_blank">
                    <img
                      src="/public/images/icons/<%= platform %>_link.svg"
                      alt="<%= platform %> link"
                    />
                  </a>
                </div>
                <% } %> <% } %>
              </div>
              <% } %>
              <!--  -->
              <% if(profileData.bio.replace(/<[^>]*>/g, '').trim() !== '') { %>
              <div class="title mt-3"><%- __("bio")%>:</div>
              <div class="data"><%- profileData.bio %></div>
              <% } %>

              <div class="p_gallery mt-4 mb-3">
                <div class="title"><%- __("gallery")%>:</div>
                <button
                  class="btn btn-sm btn-primary"
                  onclick="triggerGalleryInput()"
                >
                  <%- __("add_images")%>
                </button>
                <form action="" class="hidden">
                  <input
                    type="file"
                    name="add_gallery"
                    id="add_gallery"
                    multiple
                  />
                </form>
              </div>
              <div class="p_gallery_data" id="galleryData">
                <% profileData.gallery.forEach(image => { %>
                <div class="item">
                  <div class="remove" data-gallery-id="<%= image._id %>">+</div>
                  <img src="<%= image.media_url %>" alt="<%= image.title %>" />
                </div>
                <% }); %>
              </div>
            </div>
          </div>
        </div>

        <div class="temp_footer">
          <div class="top">
            <div class="link">
              <a target="_blank" href="/imprint"><%= __("imprint") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/privacy"> <%= __("privacyPolicy") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/terms"><%= __("termsOfUse") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/cookies">
                <%= __("cookieSettings") %></a
              >
            </div>
            <div class="link">
              <a target="_blank" href="/"> <%= __("Home") %></a>
            </div>
          </div>
          <div class="social-icons">
            <a href="https://www.youtube.com/@vibrer-official" target="_blank">
              <img
                class="yti"
                src="/public/images/youtube.svg"
                alt="Youtube icon"
            /></a>
            <a
              href="https://www.instagram.com/vibrer_official/"
              target="_blank"
            >
              <img src="/public/images/instagram.svg" alt="Instagram icon"
            /></a>
          </div>

          <div class="footer-languagebar mt-3">
            <div class="app-languageSwitcher me-1">
              <div class="item" data-value="en">
                <span><%= __("English") %></span>
              </div>
              <div class="item" data-value="fr">
                <span><%= __("French") %></span>
              </div>
              <div class="item" data-value="de">
                <span><%= __("German") %></span>
              </div>
              <div class="item" data-value="it">
                <span><%= __("Italian") %></span>
              </div>
              <div class="item" data-value="pt">
                <span><%= __("Portuguese") %></span>
              </div>
              <div class="item" data-value="tr">
                <span><%= __("Turkish") %></span>
              </div>
            </div>
          </div>

          <div class="bottom">
            <%- __("copyright").replace("{year}", new Date().getFullYear()) %>
          </div>
        </div>
      </div>
    </main>

    <!-- javascript -->
    <script src="/public/js/redirections.js?v=3.1"></script>
    <script src="/public/js/general.js?v=3.1"></script>
    <script src="/public/js/app_language.js?v=3.1"></script>
    <script src="/public/js/_modal.js?v=3.1"></script>
    <script src="/public/js/video.min.js?v=3.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

    <script>
      // let uploadCoverBtn = document.getElementById("crop_button");

      //  Croppie Functions

      const hiddenCoverWrap = document.querySelector(".hidden-coverWrap");
      const togCoverInput = document.getElementById("changeCover");
      const coveroverlay = document.querySelector(".crop-overlay");
      const covInput = document.querySelector('input[id="upload"]');
      let uploadCoverBtn = document.getElementById("uploadCover");
      let croppieInstance = null; // Moved outside to be accessible globally
      const allowedExtensions = /(\.jpg|\.jpeg|\.png|\.gif|\.heic|\.heif)$/i;
      // Function to initialize or reinitialize Croppie
      function initializeCroppie() {
        const viewportSize = adjustViewport();
        if (croppieInstance) {
          croppieInstance.destroy();
        }
        croppieInstance = new Croppie(
          document.getElementById("croppie-container"),
          {
            enableExif: true,
            viewport: {
              width: viewportSize.width,
              height: viewportSize.height,
              type: "square",
            },
            boundary: {
              width: viewportSize.width,
              height: viewportSize.height,
            },
            showZoomer: true,
          }
        );
      }

      // Adjust viewport based on window size
      function adjustViewport() {
        const targetAspectRatio = 800 / 300;
        let viewportWidth = Math.min(300, window.innerWidth - 20);
        let viewportHeight = viewportWidth / targetAspectRatio;

        const maxHeight = window.innerHeight - 100;
        if (viewportHeight > maxHeight) {
          viewportHeight = maxHeight;
          viewportWidth = viewportHeight * targetAspectRatio;
        }

        return { width: viewportWidth, height: viewportHeight };
      }

      // Trigger file input when cover-holder is clicked
      togCoverInput.addEventListener("click", function () {
        covInput.click();
      });

      // Handling image selection
      covInput.addEventListener("change", function () {
        const existingAlert = document.querySelector(".form-alert");
        if (existingAlert) {
          existingAlert.parentNode.removeChild(existingAlert);
        }
        const file = this.files[0];

        // Validate file type
        if (!allowedExtensions.exec(file.name)) {
          let errorContent = "<%-__('image_extentions')%>";
          showToastError(`Error! ${errorContent}`);

          return;
        }

        // Proceed if file type is valid
        hiddenCoverWrap.classList.remove("d-none");
        coveroverlay.style.display = "block";
        var reader = new FileReader();

        reader.onload = function (e) {
          // Initialize or reinitialize Croppie with the selected image
          initializeCroppie(); // Make sure you have this function defined as before
          croppieInstance
            .bind({
              url: e.target.result,
            })
            .then(function () {
              croppieInstance.setZoom(0);
            });
        };

        reader.readAsDataURL(file);
      });

      // Submit cropped image
      uploadCoverBtn.addEventListener("click", async function () {
        uploadCoverBtn.innerText = "<%-__('uploading')%>";
        const base64 = await croppieInstance.result({
          type: "canvas",
          size: { width: 800, height: 300 },
          quality: 1,
        });

        const response = await fetch(base64);
        const blob = await response.blob();
        const formData = new FormData();
        formData.append("type", "profile_cover");
        formData.append("profile_cover_image", blob, "cropped_image.png");

        const apiUrl = `${API_URL}upload/profile-cover-image`;

        try {
          const uploadResponse = await fetch(apiUrl, {
            method: "POST",
            body: formData,
            headers: {
              Authorization: `Bearer ${localStorage.getItem("appUserToken")}`,
            },
          });

          if (!uploadResponse.ok) throw new Error("Upload failed");

          const uploadResult = await uploadResponse.json();
          // console.log("Upload successful:", uploadResult);
          showToastSuccess("<%- __('image_added') %>");

          const coverHolder = document.querySelector("#coverHolder img");

          hiddenCoverWrap.classList.add("d-none");
          coveroverlay.style.display = "none";
          coverHolder.src = `${base64}`;
          window.location.reload();
        } catch (error) {
          console.log("Upload failed:", error);
          showToastError(`<%- __('error_uploading_cover') %>`);
        }
      });

      // Cancel and clear Croppie
      document
        .querySelector(".cancel-cover")
        .addEventListener("click", function () {
          if (croppieInstance) {
            croppieInstance.bind({
              url: "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",
            });
          }
          covInput.value = ""; // Clear file input
          hiddenCoverWrap.classList.add("d-none");
          coveroverlay.style.display = "none";
        });

      document.addEventListener("DOMContentLoaded", function () {
        var headElement = document.getElementById("myProfile_options");
        var dropdown = headElement.nextElementSibling;

        // Toggle dropdown on clicking the head element
        headElement.addEventListener("click", function (event) {
          dropdown.classList.toggle("active");
          event.stopPropagation(); // Prevent the document click event from firing immediately
        });

        // Close dropdown when clicking anywhere outside
        document.addEventListener("click", function (event) {
          if (
            !headElement.contains(event.target) &&
            !dropdown.contains(event.target)
          ) {
            dropdown.classList.remove("active");
          }
        });

        // tab menu
        var tabItems = document.querySelectorAll("._tab_menu ._item");

        tabItems.forEach(function (item) {
          item.addEventListener("click", function () {
            // Remove active class from all items
            tabItems.forEach(function (i) {
              i.classList.remove("active");
            });

            // Add active class to clicked item
            item.classList.add("active");

            // Get target content ID
            var target = item.getAttribute("target");

            // Hide all tab contents
            document
              .querySelectorAll("._tab_content")
              .forEach(function (content) {
                content.classList.remove("active");
              });

            // Show target tab content
            var targetContent = document.querySelector(target);
            if (targetContent) {
              targetContent.classList.add("active");
            }
          });
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var moreButtons = document.querySelectorAll(".more-btn");

        moreButtons.forEach(function (button) {
          button.addEventListener("click", function () {
            var contentDiv = this.closest(".content");
            contentDiv.classList.toggle("expanded");
          });
        });
      });
    </script>
    <script>
      function triggerGalleryInput() {
        document.getElementById("add_gallery").click();

        document.getElementById("add_gallery").onchange = function (event) {
          if (event.target.files) {
            Array.from(event.target.files).forEach((file) => {
              const reader = new FileReader();
              reader.onload = function (e) {
                const galleryData = document.getElementById("galleryData");
                const item = document.createElement("div");
                item.className = "item";
                item.innerHTML = `<img src="${e.target.result}" alt="gallery" />`;
                galleryData.appendChild(item);
                uploadGalleryImageToServer(file); // Assuming uploadGalleryImageToServer is defined elsewhere
              };
              reader.readAsDataURL(file);
            });
          }
        };
      }

      function uploadGalleryImageToServer(file) {
        const apiUrl = `${API_URL}upload/gallery-image`;
        const formData = new FormData();
        formData.append("gallery_img", file);

        fetch(apiUrl, {
          method: "POST",
          body: formData,
          headers: {
            Authorization: `Bearer ${localStorage.getItem("appUserToken")}`,
          },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 1) {
              showToastSuccess("<%- __('image_added') %>");
            } else {
              showToastError(`Error! ${data.message}`);
            }
          })
          .catch((error) => {
            showToastError(`Error! ${error}`);
          });
      }

      function showToastSuccess(message) {
        let toast = document.querySelector(".toast");

        if (!toast) {
          toast = document.createElement("div");
          toast.className = "toast success";
          document.body.appendChild(toast);
        }

        toast.textContent = message;

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 2000);
      }
      function showToastError(message) {
        let toast = document.querySelector(".toast");

        if (!toast) {
          toast = document.createElement("div");
          toast.className = "toast error";
          document.body.appendChild(toast);
        }

        toast.textContent = message;

        toast.classList.add("show");

        setTimeout(() => {
          toast.classList.remove("show");
        }, 2000);
      }

      document
        .getElementById("galleryData")
        .addEventListener("click", function (event) {
          if (event.target.classList.contains("remove")) {
            const galleryId = event.target.getAttribute("data-gallery-id");
            removeItem(event.target, galleryId);
          }
        });

      function removeItem(element, galleryId) {
        const url = `${API_URL}remove/gallery-image/${galleryId}`;
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${localStorage.getItem("appUserToken")}`,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            // Check the API response and handle success
            element.parentElement.remove();
            showToastSuccess("<%- __('image_remove_gallery') %>");
          })
          .catch((error) => {
            console.error("<%- __('error_remove_gallery') %>:", error);
            showToastError("<%- __('fail_remove_gallery') %>");
          });
      }
    </script>
    <script>
      async function logoutAppUser() {
        try {
          // Clear token from localStorage
          localStorage.removeItem("appUserToken");

          // Clear token from server session
          await fetch("/clear-token-in-session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // You might need to send the token to the server for verification
            // Add it to the body if required
            body: JSON.stringify({
              // token: getStoredTokenFromLocalStorage(),
            }),
          });

          // Redirect to the logout page or any other desired action
          window.location.href = "/login";
        } catch (error) {
          console.error("Error during logout:", error);
          // Handle the error as needed
        }
      }
    </script>
  </body>
</html>
