<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="theme-color" content="#1e2750" />

    <meta
      name="description"
      content="Join Vibrer's prelaunch and be the first to experience a revolutionary music platform. Connect, discover, and engage with artists and music enthusiasts worldwide."
    />
    <meta
      name="keywords"
      content="music platform, music community, music discovery, artist connection, music enthusiasts"
    />
    <%- include('../partials/head'); %>
    <link href="/public/style/quill.snow.css?v=3.1" rel="stylesheet" />
    <link rel="stylesheet" href="/public/style/app.css?v=3.1" />
    <link href="/public/style/video-js.css?v=3.1" rel="stylesheet" />
  </head>
  <body class="body-dark _pr">
    <!-- loader -->
    <%- include('../partials/loader'); %>

    <!-- header -->
    <%- include('./partials/pre-header'); %>

    <main class="app_layout app_wrapper">
      <!-- main body of the app -->
      <div class="app_main preMain">
        <div class="title mb-3"><%= __('report_this_post') %></div>
        <div class="video-head">
          <video
            controls
            class="video-js"
            preload="auto"
            width="640"
            height="264"
            data-setup="{}"
          >
            <source src="<%- singleEntryData.media %>" type="video/mp4" />
            <source src="<%- singleEntryData.media %>" type="video/webm" />
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider
              upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank"
                >supports HTML5 video</a
              >
            </p>
          </video>
          <!-- <img src="/public/images/icons/playIconWhite.svg" alt="Icon" /> -->
        </div>

        <div class="report-form mt-4">
          <form
            class="form fborder"
            action="javascript:void(0)"
            method="POST"
            id="contestReportForm"
            autocomplete="off"
            enctype="multipart/form-data"
          >
            <input
              type="hidden"
              name="contest_id"
              value="<%- singleEntryData.contest._id %>"
            />
            <input
              type="hidden"
              name="entry_id"
              value="<%- singleEntryData._id %>"
            />

            <input type="hidden" name="content_type" value="Contest entry" />
            <div class="flex-box g-1">
              <label class="checkbox-container white">
                <%= __('sexual_content') %>
                <input
                  type="radio"
                  id="rr1"
                  value="Sexual content"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>
              <label class="checkbox-container white">
                <%= __('spam_or_misleading') %>
                <input
                  type="radio"
                  id="rr2"
                  value="Spam or misleading"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>
              <label class="checkbox-container white">
                <%= __('violent_or_repulsive_content') %>
                <input
                  type="radio"
                  id="rr3"
                  value="Violent or repulsive content"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('harassment_or_dangerous_acts') %>
                <input
                  type="radio"
                  id="rr4"
                  value="Harassment or dangerous acts"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('copyright_or_ownership') %>
                <input
                  type="radio"
                  id="rr5"
                  value="Copyright / Ownership"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('child_abuse') %>
                <input
                  type="radio"
                  id="rr6"
                  value="Child abuse"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('hateful_or_abusive_content') %>
                <input
                  type="radio"
                  id="rr7"
                  value="Hateful or abusive content"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('promotes_terrorism') %>
                <input
                  type="radio"
                  id="rr8"
                  value="Promotes terrorism"
                  name="report_reason"
                />
                <span class="radio-checkmark"></span>
              </label>

              <label class="checkbox-container white">
                <%= __('other_issue') %>
                <input
                  type="radio"
                  class="otherIssue"
                  id="rr9"
                  value="Other issue"
                  name="report_reason"
                  checked
                />
                <span class="radio-checkmark"></span>
              </label>
            </div>
            <div class="mt-4 mb-4">
              <div
                id="other_issue"
                style="height: auto; min-height: 100px"
              ></div>
            </div>

            <div class="grid2md mb-3">
              <div>
                <input
                  type="text"
                  placeholder="Company optional"
                  name="company"
                />
              </div>
              <div>
                <input
                  type="text"
                  placeholder="Contact Email (optional)"
                  name="contact_email"
                />
              </div>
            </div>
            <div class="error-message mt-3 d-none"></div>
            <div class="success-message mt-3 d-none">
              <%= __('reported_the_post_success') %>
              <br />
              <%= __('reported_the_post_success_text') %>
            </div>
            <button class="btn btn-primary mt-4 mb-5 submitBtn" type="submit">
              <%= __('submit') %>
            </button>
          </form>
        </div>

        <div class="temp_footer">
          <div class="top">
            <div class="link">
              <a target="_blank" href="/imprint"><%= __("imprint") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/privacy"> <%= __("privacyPolicy") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/terms"><%= __("termsOfUse") %></a>
            </div>
            <div class="link">
              <a target="_blank" href="/cookies">
                <%= __("cookieSettings") %></a
              >
            </div>
            <div class="link">
              <a target="_blank" href="/"> <%= __("Home") %></a>
            </div>
          </div>
          <div class="social-icons">
            <a href="https://www.youtube.com/@vibrer-official" target="_blank">
              <img
                class="yti"
                src="/public/images/youtube.svg"
                alt="Youtube icon"
            /></a>
            <a
              href="https://www.instagram.com/vibrer_official/"
              target="_blank"
            >
              <img src="/public/images/instagram.svg" alt="Instagram icon"
            /></a>
          </div>

          <div class="footer-languagebar mt-3">
            <div class="app-languageSwitcher me-1">
              <div class="item" data-value="en">
                <span><%= __("English") %></span>
              </div>
              <div class="item" data-value="fr">
                <span><%= __("French") %></span>
              </div>
              <div class="item" data-value="de">
                <span><%= __("German") %></span>
              </div>
              <div class="item" data-value="it">
                <span><%= __("Italian") %></span>
              </div>
              <div class="item" data-value="pt">
                <span><%= __("Portuguese") %></span>
              </div>
              <div class="item" data-value="tr">
                <span><%= __("Turkish") %></span>
              </div>
            </div>
          </div>

          <div class="bottom">
            <%- __("copyright").replace("{year}", new Date().getFullYear()) %>
          </div>
        </div>
        <!-- app main end -->
      </div>
    </main>

    <!-- javascript -->
    <script src="/public/js/redirections.js?v=3.1"></script>
    <script src="/public/js/general.js?v=3.1"></script>
    <script src="/public/js/quill.min.js?v=3.1"></script>
    <script src="/public/js/video.min.js?v=3.1"></script>
    <script src="/public/js/config.js?v=3.1"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var quill = new Quill("#other_issue", {
          modules: {
            toolbar: false,
          },
          placeholder: "Describe the issue in detail *",
          theme: "snow",
        });

        const form = document.getElementById("contestReportForm");
        const btn = document.querySelector(".submitBtn");
        const successPop = document.querySelector(".success-message");
        const errorPop = document.querySelector(".error-message");
        // Disable HTML5 validation
        form.setAttribute("novalidate", "");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          // Change button text to "Sending..."
          btn.textContent = "<%= __('loading') %>  ";
          btn.disabled = true;
          // Implement the timeout function
          setTimeout(async () => {
            let isValid = true;
            let customErrors = {};

            const formData = new FormData(form);
            formData.append("report_description", quill.getText());
            const formDataJSON = Object.fromEntries(formData.entries());

            // Validation
            for (const key in formDataJSON) {
              formDataJSON[key] = formDataJSON[key].trim();
            }

            const {
              contest_id,
              entry_id,
              content_type,
              report_reason,
              report_description,
              contact_email,
            } = formDataJSON;

            if (
              contact_email &&
              !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(
                contact_email
              )
            ) {
              isValid = false;
              customErrors.contact_email = "<%= __('invalid_email') %>  ";
            }

            // Clear previous error alerts
            const prevAlerts = document.querySelectorAll(".form-alert");
            prevAlerts.forEach((alert) => alert.remove());

            if (isValid) {
              const url = `${API_URL}entry/submitReport`;
              try {
                const response = await fetch(url, {
                  method: "POST",
                  headers: {
                    Authorization: `Bearer ${localStorage.getItem(
                      "appUserToken"
                    )}`,
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(formDataJSON),
                });
                const responseData = await response.json();
                if (response.status === 201 || response.status === 200) {
                  if (responseData.status === 1) {
                    successPop.style.display = "block";
                    btn.style.display = "none";
                    setTimeout(() => {
                      window.location.href = "/app/pre-contest/";
                    }, 5000);
                  } else {
                    errorPop.style.display = "block";
                    errorPop.innerHTML = "<%= __('already_reported') %>  ";
                    btn.style.display = "none";
                    setTimeout(() => {
                      errorPop.style.display = "none";
                    }, 5000);
                  }
                } else {
                  errorPop.style.display = "block";
                  errorPop.innerHTML = responseData.message;
                  setTimeout(() => {
                    errorPop.style.display = "none";
                  }, 5000);
                }
              } catch (err) {
                console.error("An error occurred", err);
              }
            } else {
              for (const key in customErrors) {
                const inputElement = form.querySelector(`[name="${key}"]`);
                const alertDiv = document.createElement("div");
                alertDiv.className = "form-alert error";
                alertDiv.textContent = customErrors[key];
                inputElement.parentNode.insertBefore(
                  alertDiv,
                  inputElement.nextSibling
                );
              }
            }

            // Reset the button text
            btn.textContent = "<%= __('submit') %>";
            btn.disabled = false;
          }, 1000); // 1-second delay
        });

        const reportReasonRadios = document.querySelectorAll(
          'input[name="report_reason"]'
        );
      });
    </script>
    <script>
      async function logoutAppUser() {
        try {
          // Clear token from localStorage
          localStorage.removeItem("appUserToken");

          // Clear token from server session
          await fetch("/clear-token-in-session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // You might need to send the token to the server for verification
            // Add it to the body if required
            body: JSON.stringify({
              // token: getStoredTokenFromLocalStorage(),
            }),
          });

          // Redirect to the logout page or any other desired action
          window.location.href = "/login";
        } catch (error) {
          console.error("Error during logout:", error);
          // Handle the error as needed
        }
      }
    </script>
  </body>
</html>
