<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="theme-color" content="#1e2750" />

    <meta
      name="description"
      content="Join Vibrer's prelaunch and be the first to experience a revolutionary music platform. Connect, discover, and engage with artists and music enthusiasts worldwide."
    />
    <meta
      name="keywords"
      content="music platform, music community, music discovery, artist connection, music enthusiasts"
    />
    <%- include('../partials/head'); %>

    <link href="/public/style/quill.snow.css?v=2.0" rel="stylesheet" />
    <link rel="stylesheet" href="/public/style/app.css?v=2.0" />
    <link rel="stylesheet" href="/public/style/app_ext.css?v=2.0" />
    <link rel="stylesheet" href="/public/style/modal.css?v=2.0" />
    <link href="/public/style/video-js.css?v=2.0" rel="stylesheet" />
    <link rel="stylesheet" href="/public/style/contests.css?v=2.0" />

    <style>
      :root {
        --dd-radius: 4px !important;
        --dd-shadow: 0 0 2.5em rgba(0, 0, 0, 0.1);
        --dd-overlay: rgba(0, 0, 0, 0.75);
        --dd-background: #ffffff;
        --dd-text1: #080813;
        --dd-text2: #ffffff;
        --dd-primary: #f32377;
        --dd-gradient: linear-gradient(45deg, #fb6580, #f32377) !important;
        --dd-monthBackground: var(--dd-gradient);
        --dd-monthText: var(--dd-text2);
        --dd-monthBorder: transparent;
        --dd-confirmButtonBackground: var(--dd-gradient);
        --dd-confirmButtonText: var(--dd-text2);
        --dd-selectedBackground: var(--dd-gradient);
        --dd-selectedText: var(--dd-text2);
      }
      .dd__dropdown:not(.dd-inline).dd-shown {
        transform: translateY(-5%) translateX(-50%) !important;
      }
    </style>
  </head>
  <body class="body-dark _pr">
    <!-- loader -->
    <%- include('../partials/loader'); %>

    <!-- header -->
    <header class="app_header">
      <nav class="app_layout">
        <div class="app_start_menu">
          <!-- Logo -->
          <% if (path !== '/home') { %>
          <div class="logo" onclick="toPreHome('<%= path %>')">
            <img src="/public/images/vibrer_icon.svg" alt="Logo" />
          </div>
          <% } else { %>
          <div class="logo">
            <img src="/public/images/vibrer_icon.svg" alt="Logo" />
          </div>
          <% } %>
        </div>

        <div class="app_middle_bar force_mobile">
          <ul>
            <li
              class="<%= (path == '/home') ? 'active mdb_item' : 'mdb_item' %>"
              onclick="toPreHome('<%= path %>')"
            >
              <img src="/public/images/icons/home-icon.svg" alt="Icon" />
            </li>
            <% if(profileData.user_type === 'Artist'){ %>
            <li
              class="<%= (path == '/contests') ? 'active' : '' %>"
              onclick="toTheContest('<%- path %>')"
            >
              <img src="/public/images/icons/contest-icon.svg" alt="Icon" />
            </li>
            <% } %>
          </ul>
        </div>

        <div class="app_right_menu">
          <div class="profile">
            <div class="head hphead">
              <!-- <img
                class="icon"
                src="/public/images/icons/user-icon-light.svg"
                alt="Icon"
              /> -->
              <% if (profileData.profile_img === '') { %>
              <img
                src="/public/images/default-avatar.png"
                alt="Default Avatar"
                class="avatar"
              />
              <% } else { %>
              <img
                src="<%- profileData.profile_img %>"
                alt="User Profile Image"
                class="avatar"
              />
              <% } %>
            </div>
            <div class="drop_down hpdd">
              <div class="_profile">
                <% if (profileData.profile_img === '') { %>
                <img
                  src="/public/images/default-avatar.png"
                  alt="Default Avatar"
                />
                <% } else { %>
                <img
                  src="<%- profileData.profile_img %>"
                  alt="User Profile Image"
                />
                <% } %>
                <div class="name">
                  <span><%- profileData.full_name %></span>
                  <% if(profileData.verified === true){ %>
                  <img
                    class="app_v_badge"
                    src="/public/images/icons/verified-badge.svg"
                    alt="Verified"
                  />
                  <% } %>
                </div>
                <div class="uname" id="username">
                  @<%- profileData.username %>
                </div>
              </div>

              <div class="_menu">
                <ul>
                  <li>
                    <a href="/app/pre-my-profile">
                      <img
                        src="/public/images/icons/user_icon.svg"
                        alt="Icon"
                      />
                      <span>My profile</span>
                    </a>
                  </li>
                  <li>
                    <a href="javascript:void(0)" onclick="logoutAppUser();">
                      <img src="/public/images/icons/log-off.svg" alt="Icon" />
                      <span>Logout</span>
                    </a>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </nav>
    </header>
    <main class="app_layout app_wrapper">
      <!-- main body of the app -->
      <div class="app_main preMain">
        <div class="title">Edit your profile</div>
        <form
          class="form edit-my-profile"
          id="stepForm"
          action="javascript:void(0)"
          method="post"
          autocomplete="off"
        >
          <div class="grid-2-sm mt-3">
            <div>
              <label for="userName" class="i_label">Username</label>
              <input
                type="text"
                id="userName"
                placeholder="Username"
                name="username"
                autocomplete="off"
                value="<%- profileData.username %>"
                oninput="validateUsername(this.value)"
                onblur="handleBlurEvent(this)"
              />
              <div
                id="usernameErrorMessage"
                class="form-alert error"
                style="display: none"
              ></div>
            </div>
          </div>
          <div class="mt-3">
            <label for="full_name" class="i_label">Full name</label>
            <input
              type="text"
              id="full_name"
              placeholder="Full name *"
              name="full_name"
              autocomplete="off"
              required
              value="<%- profileData.full_name %>"
            />
          </div>
          <div class="grid-2-sm g-3 mt-3">
            <div class="genderInputWrapper">
              <label for="gender" class="i_label">Gender</label>
              <div class="custom-select dfac" id="gender-opt">
                <div class="select-value dark"><%- profileData.gender %></div>
                <div class="options">
                  <div class="option" value="Male">Male</div>
                  <div class="option" value="Female">Female</div>
                </div>
                <input
                  type="hidden"
                  name="gender"
                  value="<%- profileData.gender %>"
                  autocomplete="off"
                  required
                />
              </div>
            </div>
            <div id="dateInputWrapper">
              <label for="dob" class="i_label">Date of Birth</label>
              <div class="date-input w-100">
                <input
                  type="date"
                  name="date_of_birth"
                  id="dob"
                  placeholder="Date of Birth *"
                  autocomplete="off"
                  required
                  value="<%- (profileData.date_of_birth && new Date(profileData.date_of_birth).toISOString().split('T')[0]) || '' %>"
                />
              </div>
            </div>
            <div>
              <label for="city-input" class="i_label">City</label>
              <input
                type="text"
                id="city-input"
                name="city"
                autocomplete="off"
                placeholder="City *"
                required
                value="<%- profileData.city %>"
              />
            </div>
            <div>
              <label for="country-input" class="i_label">Country</label>
              <input
                type="text"
                id="country-input"
                placeholder="Country *"
                name="country"
                autocomplete="off"
                required
                value="<%- profileData.country %>"
              />
            </div>
          </div>

          <div class="custom-select-wrapper mt-4 mb-4">
            <label for="artist_categories" class="i_label">I am a?</label>
            <div class="custom-check-select dfac" id="artists">
              <div class="placeholder">I am a? *</div>
              <div class="check-options">
                <div class="check-list grid-2-sm">
                  <% if (artistCategoriesData && artistCategoriesData.length >
                  0) { artistCategoriesData.forEach(artistCategory => { const
                  isChecked = profileData.artist_categories.some( category =>
                  category._id === artistCategory._id ); %>
                  <label class="checkbox-container">
                    <%= artistCategory.name %> <input type="checkbox" <% if
                    (isChecked) { // prettier-ignore %>checked<% } %> value="<%=
                    artistCategory._id %>" data-value="<%= artistCategory.name
                    %>" />
                    <span class="checkmark"></span>
                  </label>
                  <% }); } %>
                </div>
                <input
                  type="hidden"
                  id="artist_categories"
                  name="artist_categories"
                  value="<%= profileData.artist_categories.map(category => category._id).join(',') %>"
                  selectedValues="<%= profileData.artist_categories.map(category => category.name).join(',') %>"
                  autocomplete="off"
                />
                <div class="divider w-100 mt-4"></div>
                <div class="ccs-foter dfjcfe">
                  <button
                    class="btn btn-primary h-auto close-options"
                    type="button"
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
            <div class="selected-items" style="display: flex">
              <% if (profileData.artist_categories &&
              profileData.artist_categories.length > 0) {
              profileData.artist_categories.forEach(selectedCategory => { %>
              <div class="item">
                <div class="item-name"><%= selectedCategory.name %></div>
              </div>
              <% }); } %>
            </div>
          </div>

          <div class="custom-select-wrapper mb-4">
            <label for="genres" class="i_label">Genre</label>
            <div class="custom-check-select dfac" id="genre">
              <div class="placeholder">Genre *</div>
              <div class="check-options">
                <div class="check-list grid-2-sm">
                  <% if (genreData && genreData.length > 0) {
                  genreData.forEach(genre => { const isChecked =
                  profileData.genres.some( genres => genres._id === genre._id );
                  %>
                  <label class="checkbox-container">
                    <%= genre.name %> <input type="checkbox" <% if (isChecked) {
                    // prettier-ignore %>checked<% } %> value="<%= genre._id %>"
                    data-value="<%= genre.name %>" />
                    <span class="checkmark"></span>
                  </label>
                  <% }); } %>
                </div>
                <input
                  type="hidden"
                  id="genres"
                  name="genres"
                  value="<%= profileData.genres.map(genre => genre._id).join(',') %>"
                  selectedValues="<%= profileData.genres.map(genre => genre.name).join(',') %>"
                  autocomplete="off"
                />
                <div class="divider w-100 mt-4"></div>
                <div class="ccs-foter dfjcfe">
                  <button
                    class="btn btn-primary h-auto close-options"
                    type="button"
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
            <div class="selected-items" style="display: flex">
              <% if (profileData.genres && profileData.genres.length > 0) {
              profileData.genres.forEach(genres => { %>
              <div class="item">
                <div class="item-name"><%= genres.name %></div>
              </div>
              <% }); } %>
            </div>
          </div>

          <div class="mb-3">
            <label for="bio" class="i_label">Bio</label>
            <div id="bio" style="height: auto; min-height: 100px">
              <%- profileData.bio %>
            </div>
          </div>

          <div class="mb-3">
            <label for="youtube" class="i_label">YouTube</label>
            <input
              type="text"
              placeholder="YouTube"
              autocomplete="off"
              name="youtube"
              value="<%- profileData.link.youtube %>"
            />
          </div>
          <div class="mb-3">
            <label for="instagram" class="i_label">Instagram</label>
            <input
              type="text"
              placeholder="Instagram"
              autocomplete="off"
              name="instagram"
              value="<%- profileData.link.instagram %>"
            />
          </div>
          <div class="mb-3">
            <label for="facebook" class="i_label">Facebook</label>
            <input
              type="text"
              placeholder="Facebook"
              autocomplete="off"
              name="facebook"
              value="<%- profileData.link.facebook %>"
            />
          </div>
          <div class="mb-3">
            <label for="twitter" class="i_label">Twitter</label>
            <input
              type="text"
              placeholder="Twitter"
              autocomplete="off"
              name="twitter"
              value="<%- profileData.link.twitter %>"
            />
          </div>
          <div class="mb-3">
            <label for="website" class="i_label">Website</label>
            <input
              type="text"
              placeholder="Website"
              autocomplete="off"
              name="website"
              value="<%- profileData.link.website %>"
            />
          </div>
          <div class="error-message mt-3 d-none"></div>
          <div class="success-message mt-3 d-none"></div>

          <div class="mt-4">
            <button class="btn btn-primary submitBtn" type="submit">
              Update information
            </button>
          </div>
        </form>
        <!-- app main end -->
      </div>
    </main>

    <!-- javascript -->
    <script src="/public/js/redirections.js?v=2.0"></script>
    <script src="/public/js/general.js?v=2.0"></script>
    <script src="/public/js/_modal.js?v=2.0"></script>
    <script src="/public/js/video.min.js?v=2.0"></script>
    <script src="/public/js/Youtube.min.js?v=2.0"></script>
    <script src="/public/js/cookieBanner.js?v=2.0"></script>
    <script src="/public/js/select.js?v=2.0"></script>
    <script src="/public/js/check-select.js?v=2.0"></script>
    <script src="/public/plugins/datedropper/datedropper-javascript.js?v=2.0"></script>
    <script src="/public/js/quill.min.js?v=2.0"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4ijUxSISsbNS29gjv8onur04fqQ8zets&libraries=places"></script>
    <script src="/public/js/config.js?v=2.0"></script>

    <script>
      //   date
      document.addEventListener("DOMContentLoaded", (event) => {
        function calculateMaxYear() {
          const currentDate = new Date();
          const maxYear = currentDate.getFullYear() - 14;
          return maxYear;
        }

        const maxYear = calculateMaxYear();

      new dateDropper({
        selector: "#dob",
        format: "y-mm-dd",
        lang: "en",
        showArrowsOnHover: true,
        overlay: false,
        expandable: false,
        expandedOnly: false,
        doubleView: false,
        startFromMonday: false,
        maxYear: maxYear.toString(),
        minYear: "1900",
        // jump: "10",
        range: false,
        defaultDate: "<%- profileData.date_of_birth %>", // Example default date
      });

      var quill = new Quill("#bio", {
        modules: {
          toolbar: false, // This hides the toolbar
        },
        placeholder: "Bio *",
        theme: "snow",
      });
    </script>
    <script>
      var autocomplete = new google.maps.places.Autocomplete(
        document.getElementById("city-input")
      );

      autocomplete.setOptions({
        types: ["(cities)"],
        disableHistory: true,
      });
      autocomplete.addListener("place_changed", function () {
        var place = autocomplete.getPlace();
        var country, city;

        for (var i = 0; i < place.address_components.length; i++) {
          var addressType = place.address_components[i].types[0];
          if (addressType === "country") {
            country = place.address_components[i].long_name;
          } else if (
            addressType === "locality" ||
            addressType === "administrative_area_level_3"
          ) {
            city = place.address_components[i].long_name;
          }
        }

        if (country && city) {
          document.getElementById("country-input").value = country;
          document.getElementById("city-input").value = city;
        }
      });

      window.addEventListener("DOMContentLoaded", (event) => {
        document
          .querySelector("#stepForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            const errorPop = document.querySelector(".error-message");
            const successPop = document.querySelector(".success-message");
            const btn = document.querySelector(".submitBtn");

            btn.textContent = "Loading...";
            btn.disabled = true;

            const form = e.target;
            const formData = new FormData(form);

            // Convert FormData to JSON
            const formDataJSON = {};
            formData.forEach((value, key) => {
              formDataJSON[key] = value.trim(); // Trim each value
            });

            const genresString = formDataJSON.genres;
            if (genresString) {
              formDataJSON.genres = genresString
                .split(",")
                .map((genre) => genre.trim());
            }

            const artistCategoriesString = formDataJSON.artist_categories;
            if (artistCategoriesString) {
              formDataJSON.artist_categories = artistCategoriesString
                .split(",")
                .map((category) => category.trim());
            }
            formDataJSON.bio = quill.getText();

            const url = `${API_URL}update/appUser`;

            try {
              const response = await fetch(url, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem(
                    "appUserToken"
                  )}`,
                },
                body: JSON.stringify(formDataJSON),
              });

              const responseData = await response.json();
              if (response.status === 201 || response.status === 200) {
                if (responseData.status === 1) {
                  // Handle success
                  successPop.style.display = "block";
                  successPop.innerHTML = "Profile completed successfully";
                  setTimeout(() => {
                    successPop.style.display = "none";
                    // window.location.href = window.location.href;
                  }, 5000);
                  // form.reset();
                } else {
                  // Handle API response with an error status
                  errorPop.style.display = "block";
                  if (responseData.error) {
                    responseData.message = responseData.error;
                  }
                  errorPop.innerHTML = responseData.message;
                  setTimeout(() => {
                    errorPop.style.display = "none";
                  }, 5000);
                }
              } else {
                // Handle HTTP error
                errorPop.style.display = "block";
                if (responseData.error) {
                  responseData.message = responseData.error;
                }
                errorPop.innerHTML = responseData.message;
                setTimeout(() => {
                  errorPop.style.display = "none";
                }, 5000);
              }
              btn.textContent = "Update information";
              btn.disabled = false;
            } catch (err) {
              // Handle fetch error
              console.error("An error occurred", err);
              btn.textContent = "Update information";
              btn.disabled = false;
            }
          });
      });
    </script>
    <script>
      let isUserLeftInputBox = false;

      function handleBlurEvent(inputElement) {
        isUserLeftInputBox = true;
        validateUsername(inputElement.value.trim());
      }

      function validateUsername(username) {
        const usernameRegex = /^[a-zA-Z0-9 _.-]+$/;
        const minLength = 3;
        const errorMessageContainer = document.getElementById(
          "usernameErrorMessage"
        );

        if (!username.trim()) {
          displayError("Username cannot be empty");
        } else if (username.length < minLength) {
          displayError(
            `Username must be at least ${minLength} characters long`
          );
        } else if (!usernameRegex.test(username)) {
          displayError(
            "Username must only contain alphabets, numbers, spaces, underscores, hyphens, and dots"
          );
        } else {
          clearError();
          if (isUserLeftInputBox) {
            // Call the API only if the user has left the input box
            checkUsernameAvailability(username);
          }
        }
      }

      function displayError(message) {
        const errorMessageContainer = document.getElementById(
          "usernameErrorMessage"
        );
        errorMessageContainer.textContent = message;
        errorMessageContainer.style.display = "block";
      }

      function clearError() {
        const errorMessageContainer = document.getElementById(
          "usernameErrorMessage"
        );
        errorMessageContainer.textContent = "";
        errorMessageContainer.style.display = "none";
      }

      async function checkUsernameAvailability(username) {
        try {
          const url = `${API_URL}/check/username`;

          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("appUserToken")}`,
            },
            body: JSON.stringify({ username }),
          });

          const data = await response.json();

          if (data && data.status === 0 && data.result.is_exists) {
            displayError("Username is already taken");
          }
        } catch (error) {
          console.error("Error checking username availability:", error);
        }
      }
    </script>
    <script>
      async function logoutAppUser() {
        try {
          // Clear token from localStorage
          localStorage.removeItem("appUserToken");

          // Clear token from server session
          await fetch("/clear-token-in-session", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            // You might need to send the token to the server for verification
            // Add it to the body if required
            body: JSON.stringify({
              // token: getStoredTokenFromLocalStorage(),
            }),
          });

          // Redirect to the logout page or any other desired action
          window.location.href = "/login";
        } catch (error) {
          console.error("Error during logout:", error);
          // Handle the error as needed
        }
      }
    </script>
  </body>
</html>
