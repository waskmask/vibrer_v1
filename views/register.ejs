<!DOCTYPE html>
<html lang="en">
  <head>
    <meta
      name="description"
      content="Join Vibrer's prelaunch and be the first to experience a revolutionary music platform. Connect, discover, and engage with artists and music enthusiasts worldwide."
    />
    <meta
      name="keywords"
      content="music platform, prelaunch, music community, music discovery, artist connection, music enthusiasts"
    />
    <%- include('partials/head'); %>
    <link rel="stylesheet" href="/public/style/app.css?v=2.0" />
  </head>

  <body>
    <!-- Loader -->
    <%- include('partials/loader'); %>
    <main>
      <section class="auth auth-pages" id="register">
        <div class="auth-container">
          <img
            class="bg-img"
            src="/public/images/auth-register.jpg"
            alt="Image"
          />
          <div class="overlay"></div>
          <div class="left-col">
            <div class="title">
              Welcome to Vibrer, the ultimate music platform for talented
              artists and passionate fans!
            </div>
          </div>
          <div class="auth-col">
            <div class="form-wrapper">
              <img
                class="logo"
                src="/public/images/vibrer_light_logo.svg"
                alt="Logo"
              />
              <div class="title">Create new account</div>
              <div class="sub">Join the music revolution.</div>
              <form
                action="javascript:void(0)"
                id="registrationForm"
                method="POST"
                autocomplete="off"
              >
                <div class="label text-white">I'm an?</div>
                <div class="custom-radio-label">
                  <div
                    class="label active"
                    onclick="handleRadioClick(this, 'Artist')"
                  >
                    Artist
                  </div>
                  <div class="label" onclick="handleRadioClick(this, 'Fan')">
                    Fan
                  </div>
                </div>
                <!-- Hidden input field to store the selected value -->
                <input
                  type="hidden"
                  id="type"
                  name="user_type"
                  value="Artist"
                />

                <div class="mb-3">
                  <input
                    class="form-input"
                    type="email"
                    placeholder="Email address"
                    name="email"
                    id="registerEmail"
                    required
                    autocomplete="off"
                  />
                </div>
                <div class="mb-3 passInputDiv">
                  <input
                    class="form-input"
                    type="password"
                    placeholder="Password"
                    name="password"
                    required
                    autocomplete="off"
                    id="registerPassword"
                  />
                  <div class="passInput">
                    <img src="/public/images/icons/visibility.svg" alt="Icon" />
                  </div>
                </div>

                <div class="mb-3 passInputDiv">
                  <input
                    class="form-input"
                    type="password"
                    placeholder="Confirm password"
                    id="confirmPassword"
                    name="confirmPassword"
                  />
                  <div class="passInput">
                    <img src="/public/images/icons/visibility.svg" alt="Icon" />
                  </div>
                </div>

                <div class="notice mb-4">
                  By signing up, I agree to the
                  <a href="/privacy" target="_blank">Privacy Policy</a> and
                  <a href="/terms" target="_blank">T&C</a>.
                </div>
                <div class="error-message mt-3 d-none"></div>
                <div class="success-message mt-3 d-none">
                  You have successfully registered.
                  <br />
                  You will receive a verification email shortly, if not found,
                  check spam folder.
                </div>
                <button class="btn btn-primary w-100 submitBtn" type="submit">
                  Sign Up
                </button>
              </form>

              <div class="text-white mt-4 dfac">
                Do have an account?
                <a class="link-primary dfac ms-1" href="/login"
                  >Login
                  <img
                    src="/public/images/icons/arrow-right-long-primary.svg"
                    alt="icon"
                /></a>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>
    <!-- javascript -->
    <script src="/public/js/cookieBanner.js?v=2.0"></script>
    <script src="/public/js/theme-v01node.js?v=2.0"></script>
    <script src="/public/js/authForm.js?v=2.0"></script>
    <script src="/public/js/config.js?v=2.0"></script>
    <script>
      function handleRadioClick(clickedElement, value) {
        // Remove the "active" class from all label elements
        const allLabels = document.querySelectorAll(".label");
        allLabels.forEach((label) => label.classList.remove("active"));

        // Add the "active" class to the clicked label element
        clickedElement.classList.add("active");

        // Save the selected value to the hidden input field
        const hiddenInput = document.getElementById("type");
        hiddenInput.value = value;
      }

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("registrationForm");
        const btn = document.querySelector(".submitBtn");
        const successPop = document.querySelector(".success-message");
        const errorPop = document.querySelector(".error-message");
        // Disable HTML5 validation
        form.setAttribute("novalidate", "");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          // Change button text to "Sending..."
          btn.textContent = "Loading...";
          btn.disabled = true;
          // Implement the timeout function
          setTimeout(async () => {
            let isValid = true;
            let customErrors = {};

            const formData = new FormData(form);
            const formDataJSON = Object.fromEntries(formData.entries());

            // Validation
            for (const key in formDataJSON) {
              formDataJSON[key] = formDataJSON[key].trim();
            }

            const { type, email, password, confirmPassword } = formDataJSON;

            if (
              !email ||
              !/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)
            ) {
              isValid = false;
              customErrors.email = !email
                ? "Email is required"
                : "Please enter a valid email";
            }

            if (!isStrongPassword(password)) {
              isValid = false;
              customErrors.password =
                "Password must be strong and contain at least 8 characters, including uppercase, lowercase, numbers, and special characters.";
            }

            if (password !== confirmPassword) {
              isValid = false;
              customErrors.confirmPassword = "Passwords do not match";
            }

            // Clear previous error alerts
            const prevAlerts = document.querySelectorAll(".form-alert");
            prevAlerts.forEach((alert) => alert.remove());

            if (isValid) {
              const url = `${API_URL}registerUser`;
              try {
                const response = await fetch(url, {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify(formDataJSON),
                });
                const responseData = await response.json();
                if (response.status === 201 || response.status === 200) {
                  if (responseData.status === 1) {
                    successPop.style.display = "block";
                    localStorage.setItem(
                      "appUserToken",
                      responseData.result.token
                    );
                    await fetch("/store-token-in-session", {
                      method: "POST",
                      headers: {
                        "Content-Type": "application/json",
                      },
                      body: JSON.stringify({
                        token: responseData.result.token,
                      }),
                    });
                    setTimeout(() => {
                      successPop.style.display = "none";
                      window.location.href = "/new-profile";
                    }, 5000);
                    form.reset();
                  } else {
                    errorPop.style.display = "block";
                    errorPop.innerHTML = responseData.message;
                    setTimeout(() => {
                      errorPop.style.display = "none";
                    }, 5000);
                  }
                } else {
                  console.log(response);
                }
              } catch (err) {
                console.error("An error occurred", err);
              }
            } else {
              for (const key in customErrors) {
                const inputElement = form.querySelector(`[name="${key}"]`);
                const alertDiv = document.createElement("div");
                alertDiv.className = "form-alert error";
                alertDiv.textContent = customErrors[key];
                inputElement.parentNode.insertBefore(
                  alertDiv,
                  inputElement.nextSibling
                );
              }
            }

            // Reset the button text
            btn.textContent = "Sign Up";
            btn.disabled = false;
          }, 1000); // 1-second delay
        });
      });

      function isStrongPassword(password) {
        // Check for strong password criteria
        const strongPasswordRegex =
          /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        return strongPasswordRegex.test(password);
      }
    </script>
  </body>
</html>
